name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 6 AM UTC
    - cron: '0 6 * * *'

jobs:
  # Quick tests for PRs
  test-pr:
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          dist
          .astro
        key: ${{ runner.os }}-build-${{ hashFiles('src/**', 'package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    - name: Build project
      id: build
      run: npm run build
      continue-on-error: false
      
    - name: Run Playwright tests (PR - Quick Tests)
      run: npx playwright test tests/home.spec.ts tests/basic-functionality.spec.ts tests/form-functionality.spec.ts
      env:
        PUBLIC_WEB3FORMS_KEY: ${{ secrets.WEB3FORMS_KEY }}
    
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-pr
        path: playwright-report/
        retention-days: 7
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-pr
        path: test-results/
        retention-days: 7

  # Full tests for main branch
  test-main:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          dist
          .astro
        key: ${{ runner.os }}-build-${{ hashFiles('src/**', 'package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-build-
    
    - name: Build project
      id: build
      run: npm run build
      continue-on-error: false
      
    - name: Run Playwright tests (Main - Full Suite)
      run: npx playwright test
      env:
        PUBLIC_WEB3FORMS_KEY: ${{ secrets.WEB3FORMS_KEY }}
        EXTENDED_TESTS: true
    
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-main
        path: playwright-report/
        retention-days: 30

  # Scheduled comprehensive tests (nightly)
  scheduled-tests:
    if: github.event_name == 'schedule'
    timeout-minutes: 45
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    - name: Build project
      run: npm run build
      continue-on-error: false
    
    - name: Run All Tests with Extended Browsers
      run: npx playwright test
      env:
        PUBLIC_WEB3FORMS_KEY: ${{ secrets.WEB3FORMS_KEY }}
        EXTENDED_TESTS: true
    
    - name: Upload Scheduled Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scheduled-test-results
        path: test-results/
        retention-days: 30

  # Visual regression tests (only on specific trigger)
  visual-tests:
    if: contains(github.event.head_commit.message, '[visual]') || github.event_name == 'workflow_dispatch'
    timeout-minutes: 20
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
    
    - name: Build project
      run: npm run build
    
    - name: Run Visual Regression Tests
      run: npx playwright test tests/visual-regression.spec.ts --project="Desktop Chrome"
      env:
        PUBLIC_WEB3FORMS_KEY: ${{ secrets.WEB3FORMS_KEY }}
    
    - name: Upload Visual Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: visual-test-results
        path: test-results/
        retention-days: 14

  # Mobile and browser compatibility tests are now included in main test runs
  # They use the streamlined device configurations from playwright.config.ts

  # Generate test summary
  test-summary:
    if: always() && (needs.test-pr.result != 'skipped' || needs.test-main.result != 'skipped')
    needs: [test-pr, test-main]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download test results if available
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        path: test-artifacts/
        pattern: test-results-*
        merge-multiple: true
    
    - name: Generate Test Summary
      run: |
        echo "# ðŸŽ­ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“Š Test Execution Status" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status | Type |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test-pr.result }}" != "skipped" ]; then
          STATUS_ICON="âœ…"
          [ "${{ needs.test-pr.result }}" != "success" ] && STATUS_ICON="âŒ"
          echo "| test-pr | $STATUS_ICON ${{ needs.test-pr.result }} | Quick smoke tests |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-main.result }}" != "skipped" ]; then
          STATUS_ICON="âœ…"
          [ "${{ needs.test-main.result }}" != "success" ] && STATUS_ICON="âŒ"
          echo "| test-main | $STATUS_ICON ${{ needs.test-main.result }} | Full test suite |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Try to extract test counts from JSON results if available
        if [ -d "test-artifacts" ] && [ -f "test-artifacts/results.json" ]; then
          echo "## ðŸ“ˆ Test Metrics" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(jq '.tests | length' test-artifacts/results.json 2>/dev/null || echo "N/A")
          PASSED=$(jq '[.tests[] | select(.outcome == "expected")] | length' test-artifacts/results.json 2>/dev/null || echo "N/A")
          FAILED=$(jq '[.tests[] | select(.outcome != "expected")] | length' test-artifacts/results.json 2>/dev/null || echo "N/A")
          echo "- **Total Tests**: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed**: $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš™ï¸ Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Core Browsers**: Chrome, Firefox" >> $GITHUB_STEP_SUMMARY
        echo "- **Mobile Devices**: iOS Safari, Android Chrome" >> $GITHUB_STEP_SUMMARY
        echo "- **Parallel Workers**: 4" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Times**: < 15 min (PR) / < 30 min (Main)" >> $GITHUB_STEP_SUMMARY

  # Lighthouse CI for performance monitoring
  lighthouse:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project
      run: npm run build
    
    - name: Start server
      run: npm run preview &
      
    - name: Wait for server
      run: npx wait-on http://localhost:4321 --timeout 30000
    
    - name: Run Lighthouse CI
      id: lighthouse
      continue-on-error: true
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun || echo "Lighthouse assertions failed, but continuing"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
    
    - name: Lighthouse Report Summary
      if: always()
      run: |
        echo "## Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.lighthouse.outcome }}" == "success" ]; then
          echo "âœ… All Lighthouse checks passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Some Lighthouse checks did not meet targets" >> $GITHUB_STEP_SUMMARY
          echo "View the full report in the Lighthouse CI output above" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Reports are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY

  # Notify on failures
  notify-on-failure:
    if: failure()
    needs: [test-pr, test-main, scheduled-tests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Create Issue on Test Failure
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `Test Failure: ${context.workflow} - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Test Failure Report
          
          **Workflow**: ${context.workflow}
          **Run**: ${context.runNumber}
          **Commit**: ${context.sha}
          **Branch**: ${context.ref}
          
          ### Failed Jobs
          - PR Tests: ${{ needs.test-pr.result }}
          - Main Tests: ${{ needs.test-main.result }}
          - Scheduled Tests: ${{ needs.scheduled-tests.result }}
          
          **Action**: [View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          Please check the test results and fix any failing tests.
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'test-failure', 'automated']
          });