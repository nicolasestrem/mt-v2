---
// This page displays the merchandise shop.
// It fetches product data from a local JSON file and renders a grid of products.
// The page also includes SEO optimizations with structured data (Product, Breadcrumb, FAQ)
// and a client-side script for analytics and lazy loading.
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Icons from '../components/Icons.astro';
import products from '../data/shop-products.json';
import '../styles/shop.css';

// SEO Meta Data
const pageTitle = "Mobility Trailblazers Shop - Nachhaltige Merchandise & Premium Poloshirts";
const pageDescription = "Entdecken Sie exklusive Mobility Trailblazers Merchandise - nachhaltig produzierte Craft Core Unify Poloshirts, Tassen & Sticker. Unterstützen Sie die Mobilitätswende mit hochwertigen Produkten. ✓ On-Demand Produktion ✓ 30 Tage Rückgaberecht";
const canonicalURL = "https://mobilitytrailblazers.de/shop";

// Enhanced product descriptions for SEO
const enhancedDescriptions = {
  "Mobility Trailblazers Pionierserie I": "Exklusives Design der Pionierserie I - Symbol für Mut und Innovation in der Mobilitätswende. Perfekt für Mobility-Professionals und Nachhaltigkeitsexperten.",
  "Mobilität durch Mut - Mobilitas per Audaciam": "Unser Leitmotiv als hochwertiges Poloshirt. Das lateinische Motto symbolisiert den Mut zur Veränderung im Verkehrssektor.",
  "Logo Mobility Trailblazers": "Das offizielle Mobility Trailblazers Logo - Erkennungszeichen für Vorreiter der nachhaltigen Mobilität."
};

// Robust price parsing function with fallback
function parsePrice(priceString: string): string {
  try {
    // Extract numeric value with comma/period handling
    const match = priceString.match(/[\d,]+(?:[.,]\d{1,2})?/);
    if (match) {
      // Replace comma with period for decimal parsing
      const normalizedPrice = match[0].replace(',', '.');
      const parsedValue = parseFloat(normalizedPrice);
      
      // Validate the parsed value
      if (!isNaN(parsedValue) && parsedValue >= 0) {
        return parsedValue.toFixed(2);
      }
    }
    
    // Fallback to 0.00 if parsing fails
    console.warn(`Failed to parse price: "${priceString}"`);
    return "0.00";
  } catch (error) {
    console.error(`Error parsing price: "${priceString}"`, error);
    return "0.00";
  }
}

// Validate product data structure
function validateProduct(product: any): boolean {
  const requiredFields = ['name', 'description', 'price', 'image', 'url'];
  return requiredFields.every(field => 
    product.hasOwnProperty(field) && 
    product[field] !== null && 
    product[field] !== undefined && 
    product[field] !== ''
  );
}

// Safe products with validation
const validProducts = products.filter(product => {
  const isValid = validateProduct(product);
  if (!isValid) {
    console.warn('Invalid product data detected:', product);
  }
  return isValid;
});

// Product Schema generation with error handling
const productSchema = validProducts.map((product, index) => ({
  "@type": "Product",
  "position": index + 1,
  "name": product.name + " - " + product.description,
  "description": enhancedDescriptions[product.description] || product.description,
  "image": product.image,
  "brand": {
    "@type": "Brand",
    "name": "Mobility Trailblazers"
  },
  "offers": {
    "@type": "Offer",
    "url": product.url,
    "price": parsePrice(product.price),
    "priceCurrency": "EUR",
    "availability": "https://schema.org/InStock",
    "seller": {
      "@type": "Organization",
      "name": "Spreadshirt"
    },
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingRate": {
        "@type": "MonetaryAmount",
        "value": "3.99",
        "currency": "EUR"
      },
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "businessDays": {
          "@type": "QuantitativeValue",
          "minValue": 3,
          "maxValue": 5
        }
      }
    }
  }
}));

const shopSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Mobility Trailblazers Shop Kollektion",
  "description": "Nachhaltig produzierte Merchandise-Artikel für Vorreiter der Mobilitätswende",
  "numberOfItems": validProducts.length,
  "itemListElement": productSchema
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://mobilitytrailblazers.de/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Shop",
      "item": "https://mobilitytrailblazers.de/shop"
    }
  ]
};

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "Wie werden die Mobility Trailblazers Produkte hergestellt?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Alle Produkte werden on-demand von Spreadshirt produziert, wodurch Überproduktion vermieden und Nachhaltigkeit gefördert wird."
      }
    },
    {
      "@type": "Question",
      "name": "Wie lange dauert die Lieferung?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Die Lieferung erfolgt innerhalb von 3-5 Werktagen direkt von Spreadshirt."
      }
    },
    {
      "@type": "Question",
      "name": "Kann ich die Produkte zurückgeben?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Ja, Sie haben 30 Tage Rückgaberecht bei Nichtgefallen über Spreadshirt."
      }
    }
  ]
};

// Schema validation function to ensure safe JSON.stringify
function validateSchema(schema: any): boolean {
  if (!schema || typeof schema !== 'object') return false;
  if (!schema['@context'] || !schema['@type']) return false;
  
  // Basic type checking for common schema properties
  const allowedTypes = ['string', 'number', 'boolean', 'object'];
  
  function validateObject(obj: any, isRoot = false): boolean {
    for (const key in obj) {
      const value = obj[key];
      if (value === null || value === undefined) continue;
      
      const valueType = typeof value;
      
      if (Array.isArray(value)) {
        // Recursively validate array items
        for (const item of value) {
          if (typeof item === 'object' && item !== null) {
            // For nested schema objects, check if they have @type
            if (item['@type'] && !validateObject(item)) return false;
            // Otherwise just validate as regular object
            else if (!item['@type'] && !validateObject(item)) return false;
          }
        }
      } else if (valueType === 'object') {
        // Skip validation for @context as it's a special case
        if (key === '@context') continue;
        // Recursively validate nested objects
        if (!validateObject(value)) return false;
      } else if (!allowedTypes.includes(valueType)) {
        return false;
      }
    }
    return true;
  }
  
  return validateObject(schema, true);
}

// Safe JSON stringify with validation
function safeJsonStringify(schema: any): string {
  try {
    if (!validateSchema(schema)) {
      console.warn('Schema validation failed, returning empty object');
      return '{}';
    }
    return JSON.stringify(schema);
  } catch (error) {
    console.error('Error stringifying schema:', error);
    return '{}';
  }
}
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  canonical={canonicalURL}
  ogType="website"
  ogImage="https://mobilitytrailblazers.de/og-shop.jpg"
>
  <Fragment slot="head">
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://image.spreadshirtmedia.net" crossorigin>
    <link rel="dns-prefetch" href="https://award-mobility-trailblazers.myspreadshop.de">
    
    <!-- Shop Schema Markup -->
    <script type="application/ld+json" set:html={safeJsonStringify(shopSchema)} />
    
    <!-- Breadcrumb Schema -->
    <script type="application/ld+json" set:html={safeJsonStringify(breadcrumbSchema)} />
    
    <!-- FAQ Schema -->
    <script type="application/ld+json" set:html={safeJsonStringify(faqSchema)} />
    
    <!-- Additional Meta Tags -->
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="product:brand" content="Mobility Trailblazers" />
    <meta property="product:availability" content="in stock" />
    <meta property="product:condition" content="new" />
    <meta property="product:price:currency" content="EUR" />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
  </Fragment>

	<Header />
	
	<main class="shop-page">
		<!-- Breadcrumb Navigation -->
		<nav aria-label="Breadcrumb" class="breadcrumb">
			<div class="container">
				<ol>
					<li><a href="/">Home</a></li>
					<li><span aria-current="page">Shop</span></li>
				</ol>
			</div>
		</nav>

		<div class="shop-hero">
			<div class="container">
				<h1>Mobility Trailblazers Shop</h1>
				<p class="subtitle">Zeigen Sie Ihre Unterstützung für unsere Initiative mit unseren exklusiven Merchandise-Artikeln</p>
			</div>
		</div>

		<div class="products-section">
			<div class="container">
				<h2>Unsere Premium Kollektion</h2>
				<p class="collection-note">
					Nachhaltig produzierte Merchandise-Artikel für Vorreiter der Mobilitätswende. 
					Alle Produkte werden on-demand über unseren offiziellen Spreadshirt-Shop gefertigt und versendet.
				</p>
				
				{products.length > 0 ? (
					<div class="products-grid" role="list">
						{validProducts.length > 0 ? validProducts.map((product, index) => (
							<article 
								class="product-card-wrapper" 
								role="listitem"
								itemscope 
								itemtype="https://schema.org/Product"
							>
								<a href={`${product.url}${product.url.includes('?') ? '&' : '?'}utm_source=mobilitytrailblazers&utm_medium=website&utm_campaign=shop-products`} 
								   target="_blank" 
								   rel="noopener noreferrer"
								   class="product-card" 
								   data-track="spreadshop-product"
								   aria-label={`${product.name} - ${product.description}, Preis: ${product.price}, Jetzt bei Spreadshirt ansehen`}>
									<div class="product-image">
										<img 
											src={product.image}
											alt={`${product.name} - ${product.description} - Nachhaltige Mobility Trailblazers Merchandise`}
											loading={index < 3 ? "eager" : "lazy"}
											fetchpriority={index < 3 ? "high" : "auto"}
											width="500"
											height="500"
											itemprop="image"
										/>
										<div class="product-overlay">
											<span class="view-product">Produkt ansehen →</span>
										</div>
									</div>
									<div class="product-info">
										<h3 itemprop="name">{product.name}</h3>
										<p class="product-description" itemprop="description">
											{product.description}
											{enhancedDescriptions[product.description] && (
												<span class="product-description-extended">
													{" - " + enhancedDescriptions[product.description]}
												</span>
											)}
										</p>
										<div class="product-meta">
											{product.price && (
												<p class="product-price" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
													<span itemprop="price">{product.price}</span>
													<meta itemprop="priceCurrency" content="EUR" />
													<meta itemprop="availability" content="https://schema.org/InStock" />
												</p>
											)}
											<div class="product-badges">
												<span class="badge badge-sustainable">Nachhaltig</span>
												<span class="badge badge-ondemand">On-Demand</span>
											</div>
										</div>
									</div>
								</a>
							</article>
						)) : (
							<div class="products-fallback">
								<div class="fallback-content">
									<Icons name="alert" />
									<h3>Produktdaten werden geladen...</h3>
									<p>Es gab ein Problem beim Laden der Produktdaten. Bitte besuchen Sie unseren Shop direkt.</p>
									<div class="shop-cta">
										<a href="https://award-mobility-trailblazers.myspreadshop.de" 
										   target="_blank" 
										   rel="noopener noreferrer" 
										   class="shop-button">
											<Icons name="external-link" />
											<span>Zum Spreadshirt Shop</span>
										</a>
									</div>
								</div>
							</div>
						)}
					</div>
				) : (
					<div class="products-fallback">
						<div class="fallback-content">
							<Icons name="store" />
							<h3>Entdecken Sie unsere Kollektion</h3>
							<p>Hochwertige T-Shirts, Hoodies, Tassen und mehr mit dem exklusiven Mobility Trailblazers Design</p>
							
							<div class="product-categories">
								<div class="category">
									<Icons name="tshirt" />
									<span>Bekleidung</span>
								</div>
								<div class="category">
									<Icons name="mug-hot" />
									<span>Accessoires</span>
								</div>
								<div class="category">
									<Icons name="bag-shopping" />
									<span>Taschen</span>
								</div>
								<div class="category">
									<Icons name="gift" />
									<span>Geschenke</span>
								</div>
							</div>
						</div>
					</div>
				)}
				
				<div class="shop-cta">
					<a href="https://award-mobility-trailblazers.myspreadshop.de/?utm_source=mobilitytrailblazers&utm_medium=website&utm_campaign=shop-main" 
					   target="_blank" 
					   rel="noopener noreferrer"
					   class="shop-button" 
					   data-track="spreadshop-main">
						<span>Alle Produkte im Shop ansehen</span>
						<Icons name="arrow-right" />
					</a>
				</div>
			</div>
		</div>

		<!-- FAQ Section -->
		<section class="shop-faq">
			<div class="container">
				<h2>Häufige Fragen zum Shop</h2>
				<div class="faq-grid">
					<div class="faq-item">
						<h3>Wie werden die Produkte hergestellt?</h3>
						<p>Alle Mobility Trailblazers Produkte werden on-demand von Spreadshirt produziert. Dies reduziert Überproduktion und fördert nachhaltige Herstellungsprozesse.</p>
					</div>
					<div class="faq-item">
						<h3>Wie lange dauert die Lieferung?</h3>
						<p>Die Lieferung erfolgt innerhalb von 3-5 Werktagen direkt von Spreadshirt. Der Versand erfolgt klimaneutral.</p>
					</div>
					<div class="faq-item">
						<h3>Welche Zahlungsmethoden werden akzeptiert?</h3>
						<p>Spreadshirt akzeptiert alle gängigen Zahlungsmethoden inkl. PayPal, Kreditkarte und Sofortüberweisung.</p>
					</div>
					<div class="faq-item">
						<h3>Gibt es ein Rückgaberecht?</h3>
						<p>Ja, Sie haben 30 Tage Rückgaberecht bei Nichtgefallen. Die Abwicklung erfolgt problemlos über Spreadshirt.</p>
					</div>
				</div>
			</div>
		</section>

		<div class="shop-info">
			<div class="container">
				<div class="info-grid">
					<div class="info-card">
						<Icons name="truck" />
						<h3>Schneller Versand</h3>
						<p>Versand innerhalb von 3-5 Werktagen direkt von Spreadshirt</p>
					</div>
					<div class="info-card">
						<Icons name="shield-alt" />
						<h3>Sichere Zahlung</h3>
						<p>Verschlüsselte Zahlungsabwicklung über Spreadshirt</p>
					</div>
					<div class="info-card">
						<Icons name="leaf" />
						<h3>Nachhaltige Produktion</h3>
						<p>On-Demand Druck reduziert Überproduktion</p>
					</div>
					<div class="info-card">
						<Icons name="undo" />
						<h3>30 Tage Rückgaberecht</h3>
						<p>Problemlose Rückgabe bei Nichtgefallen</p>
					</div>
				</div>
			</div>
		</div>
	</main>

	<Footer />
</Layout>


<!-- Client-side enhancement to fetch fresh products -->
<script defer>
	// Lazy-load analytics functionality
	function initializeAnalytics() {
		// Enhanced tracking with e-commerce data
		// Track product impressions
		const productCards = document.querySelectorAll('.product-card');
		const products = Array.from(productCards).map((card, index) => ({
			name: card.querySelector('h3')?.textContent || '',
			price: card.querySelector('.product-price span')?.textContent || '',
			position: index + 1
		}));

		if (typeof window.trackEvent === 'function' && products.length > 0) {
			window.trackEvent('view_item_list', {
				event_category: 'ecommerce',
				item_list_name: 'Shop Page',
				items: products
			});
		}

		// Track product clicks
		document.addEventListener('click', function(e) {
			const target = e.target.closest('[data-track="spreadshop-product"], [data-track="spreadshop-main"]');
			if (target && typeof window.trackEvent === 'function') {
				const trackType = target.dataset.track;
				const productName = target.querySelector('h3')?.textContent || 'Shop Main';
				const productPrice = target.querySelector('.product-price span')?.textContent || '';
				
				window.trackEvent('select_item', {
					event_category: 'ecommerce',
					event_label: trackType,
					item_list_name: 'Shop Page',
					items: [{
						name: productName,
						price: productPrice
					}],
					link_url: target.href
				});
			}
		});

		// Intersection Observer for lazy loading enhancement
		if ('IntersectionObserver' in window) {
			const imageObserver = new IntersectionObserver((entries, observer) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const img = entry.target;
						if (img.dataset.src && !img.src) {
							img.src = img.dataset.src;
							img.removeAttribute('data-src');
							observer.unobserve(img);
						}
					}
				});
			}, {
				rootMargin: '50px 0px',
				threshold: 0.01
			});

			document.querySelectorAll('img[loading="lazy"]').forEach(img => {
				imageObserver.observe(img);
			});
		}
	}

	// Initialize analytics when user interacts or after delay
	let analyticsInitialized = false;
	function lazyLoadAnalytics() {
		if (!analyticsInitialized) {
			analyticsInitialized = true;
			initializeAnalytics();
		}
	}

	// Load analytics on user interaction or after 3 seconds
	['scroll', 'click', 'touchstart'].forEach(event => {
		document.addEventListener(event, lazyLoadAnalytics, { once: true, passive: true });
	});

	// Fallback: Load after 3 seconds if no user interaction
	setTimeout(lazyLoadAnalytics, 3000);
</script>